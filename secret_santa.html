<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Secret Santa / Christmas Friend Picker</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Mountains+of+Christmas:wght@400;700&display=swap');
    body{
      font-family:'Mountains of Christmas', cursive;
      max-width:980px;
      margin:24px auto;
      padding:18px;
      background: url('https://images.unsplash.com/photo-1601004890684-d8cbf643f5f2?auto=format&fit=crop&w=1400&q=80') no-repeat center center fixed;
      background-size: cover;
      color:#fff;
    }
    h1{
      font-size:36px;
      margin-bottom:20px;
      color:#ff4d4d;
      text-shadow: 2px 2px #000;
      text-align:center;
    }
    .card{
      background: rgba(0,0,0,0.6);
      padding:20px;
      border-radius:15px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.5);
      margin-bottom:20px;
      border: 2px solid #ff0000;
    }
    label{display:block;margin:10px 0 6px; color:#ffd700;}
    textarea,input,button{font-size:16px;padding:10px;border-radius:12px; border:none;}
    textarea,input{width:100%; margin-bottom:12px;}
    button{
      background: linear-gradient(45deg, #ff0000, #00ff00);
      color:#fff;
      cursor:pointer;
      transition: transform 0.2s;
      font-weight:bold;
    }
    button:hover{transform: scale(1.05);}
    .result{
      white-space:pre-wrap;
      background:#ffd700;
      color:#000;
      padding:12px;
      border-radius:12px;
      margin-top:8px;
      display:none;
      font-size:18px;
      text-align:center;
      font-weight:bold;
    }
    .controls{display:flex;gap:10px;margin-top:10px; flex-wrap:wrap;}
    input::placeholder, textarea::placeholder{color:#ffeb99; font-weight:bold;}
    #revealCard{display:none; text-align:center;}
  </style>
</head>
<body>
  <h1>üéÑ Secret Santa Picker üéÅ</h1>

  <div class="card">
    <label for="namesArea">Participants (one per line)</label>
    <textarea id="namesArea" rows="8" placeholder="Alice\nBob\nCarol\nDavid"></textarea>

    <label class="small">Quick add (comma separated)</label>
    <input id="quickAdd" placeholder="Eve, Frank, Grace" />
    <div class="controls">
      <button id="btnAdd">Add</button>
      <button id="btnClear">Clear</button>
      <button id="btnPopulateExample">Example</button>
    </div>

    <label for="exclusions">Exclusions (one per line using "A -> B")</label>
    <textarea id="exclusions" rows="5" placeholder="Alice -> Bob\nBob -> Alice"></textarea>

    <label>Options</label>
    <div class="controls">
      <label><input type="checkbox" id="allowSelf" /> Allow self-assignments</label>
    </div>

    <div class="controls">
      <button id="btnGenerate">Generate Pairings</button>
      <button id="btnExport">Export CSV</button>
    </div>

    <div id="status" class="small" style="margin-top:10px;"></div>
  </div>

  <div class="card" id="revealCard">
    <h4>Participant Reveal üéÅ</h4>
    <input id="nameInput" placeholder="Enter your name" />
    <button id="btnReveal">Reveal My Friend</button>
    <div id="myResult" class="result"></div>
  </div>

  <script>
    const $ = id => document.getElementById(id);

    function parseNames(text){ return text.split('\n').map(s=>s.trim()).filter(Boolean); }
    function parseExclusions(text){
      const lines = text.split('\n').map(s=>s.trim()).filter(Boolean);
      const map = {};
      for(const line of lines){
        const parts = line.split('->').map(s=>s.trim());
        if(parts.length===2){ const a=parts[0], b=parts[1]; map[a]=map[a]||new Set(); map[a].add(b); }
      }
      const out = {}; for(const k in map) out[k]=Array.from(map[k]); return out;
    }

    function generatePairings(names, exclusions={}, allowSelf=false, maxAttempts=3000){
      if(names.length===0) return {ok:false,msg:'No participants.'};
      if(names.length===1 && !allowSelf) return {ok:false,msg:'Single participant cannot be assigned without allowing self.'};
      const exMap={}; const nameSet=new Set(names);
      for(const a in exclusions){ if(!nameSet.has(a)) continue; exMap[a]=new Set((exclusions[a]||[]).filter(x=>nameSet.has(x))); }
      function isForbidden(giver, receiver){ return (!allowSelf && giver===receiver)||(exMap[giver]&&exMap[giver].has(receiver)); }
      for(let attempt=0;attempt<maxAttempts;attempt++){
        const receivers=names.slice().sort(()=>Math.random()-0.5); const assignment={}; let ok=true;
        for(let i=0;i<names.length;i++){
          const giver=names[i]; if(!isForbidden(giver,receivers[i])){ assignment[giver]=receivers[i]; continue; }
          let found=false; for(let j=i+1;j<names.length;j++){
            if(!isForbidden(giver,receivers[j]) && !isForbidden(names[j],receivers[i])){
              [receivers[i],receivers[j]]=[receivers[j],receivers[i]]; assignment[giver]=receivers[i]; found=true; break;
            }
          }
          if(!found){ ok=false; break; }
        }
        if(ok) return {ok:true,assign:assignment};
      }
      return {ok:false,msg:'Could not find valid assignment.'};
    }

    $('btnAdd').addEventListener('click',()=>{
      const q=$('quickAdd').value.trim(); if(!q) return;
      const current=$('namesArea').value.trim();
      const extras=q.split(',').map(s=>s.trim()).filter(Boolean).join('\n');
      $('namesArea').value=current?current+'\n'+extras:extras; $('quickAdd').value='';
    });

    $('btnClear').addEventListener('click',()=>{ $('namesArea').value=''; $('exclusions').value=''; $('status').textContent='Cleared'; $('revealCard').style.display='none'; });

    $('btnPopulateExample').addEventListener('click',()=>{
      $('namesArea').value=['Alice','Bob','Carol','David','Eve'].join('\n');
      $('exclusions').value='Alice -> Bob\nBob -> Alice';
    });

    $('btnGenerate').addEventListener('click',()=>{
      const names=parseNames($('namesArea').value); const exclusions=parseExclusions($('exclusions').value);
      const allowSelf=$('allowSelf').checked;
      const res=generatePairings(names,exclusions,allowSelf);
      if(!res.ok){ $('status').textContent=res.msg; return; }
      window._pairs=res.assign; window._names=names;
      $('revealCard').style.display='block'; $('myResult').style.display='none'; $('nameInput').value='';
      $('status').textContent='Pairings generated ‚Äî participants can now reveal their friends.';
    });

    $('btnReveal').addEventListener('click',()=>{
      const name=$('nameInput').value.trim(); if(!name){ $('myResult').textContent='Enter your name first.'; $('myResult').style.display='block'; return; }
      const pairs=window._pairs; if(!pairs||!pairs[name]){ $('myResult').textContent='Name not found. Check spelling.'; $('myResult').style.display='block'; return; }
       $('myResult').textContent=`üéÅ ${name}, your Secret Friend is ‚Üí ${pairs[name]} üéÑ`;
      $('myResult').style.display='block';
      setTimeout(()=>{ $('myResult').style.display='none'; $('nameInput').value=''; }, 1000); // hide after 8 seconds for privacy
    });
  </script>

  <!-- Optional: Snow Animation -->
  <canvas id="snowCanvas" style="position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:1000;"></canvas>
  <script>
    const canvas = document.getElementById('snowCanvas');
    const ctx = canvas.getContext('2d');
    let W = canvas.width = window.innerWidth;
    let H = canvas.height = window.innerHeight;

    window.addEventListener('resize',()=>{ W=canvas.width=window.innerWidth; H=canvas.height=window.innerHeight; });

    const numFlakes = 100;
    const flakes = [];

    for(let i=0;i<numFlakes;i++){
      flakes.push({x:Math.random()*W, y:Math.random()*H, r:Math.random()*4+1, d:Math.random()*numFlakes});
    }

    function drawFlakes(){
      ctx.clearRect(0,0,W,H);
      ctx.fillStyle='white';
      ctx.beginPath();
      for(let i=0;i<numFlakes;i++){
        const f=flakes[i];
        ctx.moveTo(f.x,f.y);
        ctx.arc(f.x,f.y,f.r,0,Math.PI*2,true);
      }
      ctx.fill();
      moveFlakes();
    }

    let angle=0;
    function moveFlakes(){
      angle += 0.01;
      for(let i=0;i<numFlakes;i++){
        const f=flakes[i];
        f.y += Math.cos(angle + f.d) + 1 + f.r/2;
        f.x += Math.sin(angle) * 2;
        if(f.y>H){ f.y=0; f.x=Math.random()*W; }
        if(f.x>W){ f.x=0; }
        if(f.x<0){ f.x=W; }
      }
    }

    setInterval(drawFlakes, 25);
  </script>
</body>
</html>
